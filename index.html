<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬êµíšŒ í•œêµ¬ì ˆë¬µìƒ ì¶”ì¶œê¸° (ì•ˆì „ëª¨ë“œ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Noto Sans KR', 'sans-serif'] },
                    colors: {
                        church: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: #f3f4f6;
        }

        .glass {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Drag & Drop Zone Animation */
        .drag-active {
            border-color: #0ea5e9 !important;
            background-color: #f0f9ff !important;
            transform: scale(1.02);
        }
    </style>
</head>

<body class="text-slate-800 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Main Container -->
    <main class="w-full max-w-2xl glass shadow-xl rounded-2xl overflow-hidden">
        <!-- Header -->
        <header class="bg-church-600 text-white p-6 text-center">
            <h1 class="text-2xl font-bold">ğŸ“– í•œêµ¬ì ˆë¬µìƒ ì´ë¯¸ì§€ ì¶”ì¶œê¸°</h1>
            <p class="text-church-100 text-sm mt-1 opacity-90">ì•ˆì „í•˜ê³  ê°„í¸í•œ PDF ë³€í™˜ ë„êµ¬ v4</p>
        </header>

        <!-- Content -->
        <div class="p-6 space-y-8">

            <!-- Step 1: Download & Select -->
            <div class="space-y-4">
                <div class="flex items-center gap-2">
                    <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">Step 1</span>
                    <h3 class="font-bold text-slate-800">ë‚ ì§œ ì„ íƒ ë° PDF ì¤€ë¹„</h3>
                </div>

                <!-- Date Controls -->
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">ì—°ë„</label>
                        <input type="number" id="targetYear"
                            class="w-full p-2 border rounded-lg text-center font-bold text-church-900"
                            onchange="updateLink()">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">ì›” (ìë™ê³„ì‚°)</label>
                        <select id="targetMonthPair"
                            class="w-full p-2 border rounded-lg bg-white font-bold text-church-900"
                            onchange="updateLink()">
                            <option value="1">1-2ì›”í˜¸</option>
                            <option value="3">3-4ì›”í˜¸</option>
                            <option value="5">5-6ì›”í˜¸</option>
                            <option value="7">7-8ì›”í˜¸</option>
                            <option value="9">9-10ì›”í˜¸</option>
                            <option value="11">11-12ì›”í˜¸</option>
                        </select>
                    </div>
                </div>

                <!-- Smart Link Button -->
                <div class="text-center">
                    <a id="smartLink" href="#" target="_blank"
                        class="inline-flex items-center gap-2 text-church-600 hover:text-church-800 font-medium text-sm hover:underline transition">
                        <span>ğŸ”— ì´ë²ˆ ë‹¬ êµíšŒ PDF ë‹¤ìš´ë¡œë“œí•˜ëŸ¬ ê°€ê¸°</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                    </a>
                    <p class="text-xs text-slate-400 mt-1">â€» ìœ„ ë§í¬ë¥¼ ëˆŒëŸ¬ PDFë¥¼ ì €ì¥í•œ í›„, ì•„ë˜ ìƒìì— ë„£ì–´ì£¼ì„¸ìš”.</p>
                </div>

                <!-- Drop Zone -->
                <label id="dropZone"
                    class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer bg-slate-50 hover:bg-slate-100 transition-all group">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <svg class="w-8 h-8 mb-3 text-slate-400 group-hover:text-church-500 transition" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                            </path>
                        </svg>
                        <p class="mb-2 text-sm text-slate-500 font-medium group-hover:text-church-600"><span
                                class="font-bold">í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</span> ë˜ëŠ” ì—¬ê¸°ë¡œ ë“œë˜ê·¸</p>
                        <p id="fileNameDisplay" class="text-xs text-slate-400">PDF íŒŒì¼ (.pdf)</p>
                    </div>
                    <input type="file" id="pdfFile" accept=".pdf" class="hidden" onchange="handleFileSelect(this)">
                </label>
            </div>

            <hr class="border-slate-200">

            <!-- Step 2: Settings & Extract -->
            <div class="space-y-4">
                <div class="flex items-center gap-2">
                    <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">Step 2</span>
                    <h3 class="font-bold text-slate-800">ê¸°ê°„ ì„¤ì • ë° ì¶”ì¶œ</h3>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">ì‹œì‘ì¼</label>
                        <input type="date" id="startDate" class="w-full p-2 border rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">ì¢…ë£Œì¼</label>
                        <input type="date" id="endDate" class="w-full p-2 border rounded-lg text-sm">
                    </div>
                </div>

                <div class="flex items-center space-x-2 px-1">
                    <input type="checkbox" id="excludeWeekend" class="rounded text-church-600 focus:ring-church-500">
                    <label for="excludeWeekend" class="text-sm text-slate-600 cursor-pointer">ì£¼ë§(í† /ì¼) ì œì™¸í•˜ê¸°</label>
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 pt-2">
                    <button onclick="processAndDownload('view')" id="btnView"
                        class="w-full bg-white border-2 border-church-500 text-church-600 hover:bg-church-50 font-bold py-3 px-4 rounded-xl shadow-md transition active:scale-95 flex justify-center items-center gap-2"
                        disabled>
                        <span>ğŸ“±</span> ëª¨ë°”ì¼ ë³´ê¸°
                    </button>
                    <button onclick="processAndDownload('zip')" id="btnDownload"
                        class="w-full bg-church-600 hover:bg-church-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition active:scale-95 flex justify-center items-center gap-2"
                        disabled>
                        <span>ğŸ’¾</span> ZIP ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
            </div>

            <!-- Status & Gallery -->
            <div id="statusArea"
                class="hidden bg-slate-800 text-slate-200 p-4 rounded-lg font-mono text-xs max-h-40 overflow-y-auto whitespace-pre-wrap">
            </div>

            <div id="imageGallery"
                class="hidden flex flex-col gap-4 mt-4 bg-slate-50 p-4 rounded-xl border border-slate-200">
                <h3 class="font-bold text-slate-700 text-center">ğŸ‘‡ ì´ë¯¸ì§€ë¥¼ ê¾¹ ëˆŒëŸ¬ ì €ì¥í•˜ì„¸ìš”</h3>
                <div id="galleryGrid" class="grid grid-cols-1 gap-6"></div>
            </div>

        </div>
        <footer class="bg-slate-50 border-t p-4 text-center text-xs text-slate-400">
            Meditation Extractor v4 â€¢ Safe File Processing
        </footer>
    </main>

    <!-- Hidden Canvas -->
    <canvas id="renderCanvas" class="hidden"></canvas>

    <script>
        // --- 1. Initialization ---
        const today = new Date();
        const yearInput = document.getElementById('targetYear');
        const monthSelect = document.getElementById('targetMonthPair');

        // Default Logic
        yearInput.value = today.getFullYear();
        const m = today.getMonth() + 1;
        // Map 1->1, 2->1, 3->3, 4->3, etc.
        const startM = m % 2 !== 0 ? m : m - 1;
        if ([1, 3, 5, 7, 9, 11].includes(startM)) monthSelect.value = startM;

        document.getElementById('startDate').valueAsDate = today;
        document.getElementById('endDate').valueAsDate = today;

        updateLink(); // Set initial link

        // --- 2. Smart Link Logic ---
        function updateLink() {
            const y = yearInput.value;
            const m1 = parseInt(monthSelect.value);
            const m2 = m1 + 1;

            // Generate official URL
            const fileName = `${y}_ov_${m1}-${m2}(2).pdf`; // e.g., 2026_ov_1-2(2).pdf
            const url = `https://www.woorichurch.org/sub/bible/${y}/${fileName}`;

            const linkEl = document.getElementById('smartLink');
            linkEl.href = url;
            linkEl.innerHTML = `<span>ğŸ”— ${y}ë…„ ${m1}-${m2}ì›”í˜¸ ë‹¤ìš´ë¡œë“œ (êµíšŒ í™ˆí˜ì´ì§€)</span> <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>`;
        }

        // --- 3. File Handling ---
        let selectedFile = null;

        function handleFileSelect(input) {
            const file = input.files[0];
            if (file) setFile(file);
        }

        function setFile(file) {
            if (file.type !== 'application/pdf') {
                alert('PDF íŒŒì¼ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            selectedFile = file;
            document.getElementById('fileNameDisplay').textContent = `âœ… ì„ íƒë¨: ${file.name}`;
            document.getElementById('fileNameDisplay').className = "text-sm text-church-600 font-bold mt-1";
            document.getElementById('dropZone').classList.add('bg-blue-50', 'border-church-300');

            // Enable buttons
            document.getElementById('btnView').disabled = false;
            document.getElementById('btnDownload').disabled = false;
        }

        // Drag & Drop
        const dropZone = document.getElementById('dropZone');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-active'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-active'), false);
        });
        dropZone.addEventListener('drop', (e) => {
            const file = e.dataTransfer.files[0];
            if (file) setFile(file);
        }, false);


        // --- 4. Processing Logic ---
        function getPageNumber(date, m1) {
            const INTRO_PAGES = 4;
            const targetMonth = date.getMonth() + 1;
            const day = date.getDate();

            if (targetMonth === m1) return INTRO_PAGES + day;
            else if (targetMonth === m1 + 1) {
                const y = date.getFullYear();
                const daysInM1 = new Date(y, m1, 0).getDate();
                return INTRO_PAGES + daysInM1 + day;
            }
            return null;
        }

        function log(msg, type = 'info') {
            const el = document.getElementById('statusArea');
            el.classList.remove('hidden');
            const color = type === 'error' ? 'text-red-300' : 'text-green-300';
            const icon = type === 'error' ? 'âŒ' : (type === 'success' ? 'âœ…' : 'â„¹ï¸');
            el.innerHTML += `<div>${icon} ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        async function processAndDownload(mode) {
            if (!selectedFile) {
                alert('ë¨¼ì € PDF íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // UI Prep
            const btnZip = document.getElementById('btnDownload');
            const btnView = document.getElementById('btnView');
            const gallery = document.getElementById('imageGallery');
            const galleryGrid = document.getElementById('galleryGrid');
            const statusArea = document.getElementById('statusArea');

            // Reset
            statusArea.innerHTML = '';
            statusArea.classList.remove('hidden');
            gallery.classList.add('hidden');
            galleryGrid.innerHTML = '';

            // Lock UI
            btnZip.disabled = true; btnView.disabled = true;
            const originalZipText = btnZip.innerHTML;
            const originalViewText = btnView.innerHTML;
            btnZip.innerHTML = 'â³ ì²˜ë¦¬ì¤‘...';
            btnView.innerHTML = 'â³ ì²˜ë¦¬ì¤‘...';

            try {
                // 1. Inputs
                const start = new Date(document.getElementById('startDate').value);
                const end = new Date(document.getElementById('endDate').value);
                const excludeWeekend = document.getElementById('excludeWeekend').checked;
                const m1 = parseInt(monthSelect.value);

                if (start > end) throw new Error("ì‹œì‘ì¼ì´ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ìŠµë‹ˆë‹¤.");

                // 2. Load PDF
                const arrayBuffer = await selectedFile.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                log(`PDF ë¡œë“œë¨: ${selectedFile.name} (${pdf.numPages}í˜ì´ì§€)`);

                // 3. Process
                const zip = mode === 'zip' ? new JSZip() : null;
                const canvas = document.getElementById('renderCanvas');
                const ctx = canvas.getContext('2d');
                let count = 0;

                if (mode === 'view') gallery.classList.remove('hidden');

                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    if (excludeWeekend && (d.getDay() === 0 || d.getDay() === 6)) continue;

                    const pageNum = getPageNumber(d, m1);
                    if (!pageNum || pageNum > pdf.numPages) {
                        log(`${d.toLocaleDateString()} : ë²”ìœ„ ì´ˆê³¼ (Page ${pageNum})`, 'error');
                        continue;
                    }

                    // Render
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 2.0 });
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                    const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.85));
                    const fileName = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}.jpg`;

                    if (mode === 'zip') {
                        zip.file(fileName, blob);
                        log(`${d.getMonth() + 1}/${d.getDate()} ì¶”ì¶œ ì™„ë£Œ`);
                    } else {
                        // View Mode
                        const url = URL.createObjectURL(blob);
                        const card = document.createElement('div');
                        card.className = "bg-white p-3 rounded-lg shadow border border-slate-200";
                        card.innerHTML = `
                            <div class="font-bold text-center mb-2 text-church-600">${d.getFullYear()}.${d.getMonth() + 1}.${d.getDate()}</div>
                            <img src="${url}" class="w-full rounded-md shadow-inner mb-3 border">
                            <a href="${url}" download="${fileName}" class="block w-full py-3 bg-church-50 text-church-600 font-bold text-center rounded-lg hover:bg-church-100 transition">
                                â¬‡ï¸ ì´ ì´ë¯¸ì§€ ì €ì¥
                            </a>
                        `;
                        galleryGrid.appendChild(card);
                    }
                    count++;
                }

                if (count === 0) throw new Error("ì¶”ì¶œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");

                if (mode === 'zip') {
                    log(`ZIP ì••ì¶• ì¤‘...`);
                    const zipBlob = await zip.generateAsync({ type: "blob" });
                    saveAs(zipBlob, `ë¬µìƒ_${start.toISOString().split('T')[0]}_${end.toISOString().split('T')[0]}.zip`);
                    log(`ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!`, 'success');
                } else {
                    log(`${count}ì¥ ì¶”ì¶œ ì™„ë£Œ. ì•„ë˜ì—ì„œ í™•ì¸í•˜ì„¸ìš”.`, 'success');
                    gallery.scrollIntoView({ behavior: 'smooth' });
                }

            } catch (e) {
                log(`ì˜¤ë¥˜: ${e.message}`, 'error');
                console.error(e);
            } finally {
                btnZip.disabled = false; btnView.disabled = false;
                btnZip.innerHTML = originalZipText; btnView.innerHTML = originalViewText;
            }
        }
    </script>
</body>

</html>