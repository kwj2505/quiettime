<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>í•œêµ¬ì ˆë¬µìƒ ê¸°ê°„ ì´ë¯¸ì§€ ì¶”ì¶œ</title>
  <style>
    :root{
      --bg:#070a14; --card:#0e1733; --muted:#a9b7d7; --text:#eef3ff;
      --accent:#7aa2ff; --border: rgba(122,162,255,.18);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; padding:18px 14px;
      font-family: system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", Segoe UI, Roboto, Arial;
      background: radial-gradient(1000px 600px at 20% 0%, rgba(122,162,255,.18), transparent 60%),
                  linear-gradient(180deg, #050712, #070a14 30%, #050712);
      color: var(--text);
    }
    .wrap{ max-width: 760px; margin:0 auto; }
    h1{ margin:0 0 8px; font-size: 18px; }
    .sub{ margin:0 0 14px; color: var(--muted); font-size: 13px; line-height:1.5; }
    .card{
      background: rgba(14,23,51,.92);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 12px 28px rgba(0,0,0,.28);
      margin-bottom: 12px;
    }
    label{ display:block; font-size: 12px; color: var(--muted); margin: 10px 0 6px; }
    input, select{
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(169,183,215,.22);
      background: rgba(4,8,18,.65);
      color: var(--text);
      padding: 11px 12px;
      outline: none;
      font-size: 14px;
    }
    .row{ display:grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 720px){ .row{ grid-template-columns: 1fr 1fr 1fr; } }
    .checks{ display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; }
    .chk{
      display:flex; align-items:center; gap:8px;
      font-size: 13px; color: var(--muted);
      padding: 8px 10px;
      border: 1px solid rgba(169,183,215,.18);
      border-radius: 999px;
      background: rgba(255,255,255,.04);
    }
    .chk input{ width:auto; }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    button{
      border:0; border-radius: 14px;
      padding: 12px 12px;
      cursor:pointer;
      font-weight: 900;
      font-size: 14px;
      flex:1;
    }
    .primary{ background: var(--accent); color:#061028; }
    .ghost{
      background: rgba(255,255,255,.06);
      color: var(--text);
      border: 1px solid rgba(169,183,215,.22);
    }
    .status{
      margin-top: 10px;
      font-size: 12.5px;
      color: var(--muted);
      line-height:1.5;
      white-space: pre-line;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    canvas{ display:none; }
    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.55;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ“Œ í•œêµ¬ì ˆë¬µìƒ ê¸°ê°„ ì´ë¯¸ì§€ ì¶”ì¶œ</h1>
    <p class="sub">
      ê¸°ë³¸ì€ ì›”~ê¸ˆ(í† /ì¼ ì œì™¸)ì´ë©°, ì²´í¬í•˜ë©´ í† /ì¼ê¹Œì§€ í¬í•¨í•©ë‹ˆë‹¤.<br/>
      â€» â€œì‹¤í–‰ì´ ì•ˆ ë¨â€ì˜ 1ìˆœìœ„ ì›ì¸ì€ <b>CORS</b>ì…ë‹ˆë‹¤. ì•„ë˜ â€œPDFë¥¼ GitHubì— ì˜¬ë¦¼â€ ì˜µì…˜ì„ ì‚¬ìš©í•˜ë©´ í™•ì‹¤íˆ í•´ê²°ë©ë‹ˆë‹¤.
    </p>

    <div class="card">
      <div class="row">
        <div>
          <label>ì‹œì‘ ë‚ ì§œ</label>
          <input type="date" id="startDate" />
        </div>
        <div>
          <label>ì¢…ë£Œ ë‚ ì§œ</label>
          <input type="date" id="endDate" />
        </div>
        <div>
          <label>í•´ìƒë„</label>
          <select id="quality">
            <option value="2" selected>í‘œì¤€ (ëª¨ë°”ì¼/PC ì½ê¸° ì¶©ë¶„)</option>
            <option value="3">ê³ í•´ìƒë„ (íŒŒì¼ í¼)</option>
          </select>
        </div>
      </div>

      <div class="checks">
        <label class="chk">
          <input type="checkbox" id="includeWeekend" />
          í† /ì¼ í¬í•¨
        </label>
        <label class="chk">
          <input type="checkbox" id="useLocalPdf" />
          PDFë¥¼ GitHub ì €ì¥ì†Œì— ì˜¬ë ¤ì„œ ì‚¬ìš© (ì¶”ì²œ)
        </label>
      </div>

      <div class="btns">
        <button class="primary" id="btnEach" type="button">ğŸ“¥ ê°œë³„ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</button>
        <button class="ghost" id="btnZip" type="button">ğŸ“¦ ZIPìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ</button>
      </div>

      <div class="status" id="status">ëŒ€ê¸° ì¤‘â€¦</div>

      <div class="hint">
        â€¢ í˜ì´ì§€ ë§¤í•‘: 1~4pëŠ” ì„¤ëª…, 5pë¶€í„° 1ì¼ ì‹œì‘ â†’ <span class="mono">page = 4 + day</span><br/>
        â€¢ 2ê°œì›” PDFì—ì„œ ë‘˜ì§¸ ë‹¬: <span class="mono">page = 4 + (ì²«ë‹¬ì¼ìˆ˜) + day</span><br/>
        â€¢ â€œPDFë¥¼ GitHub ì €ì¥ì†Œì— ì˜¬ë¦¼â€ì„ ì²´í¬í•˜ë©´ <span class="mono">./pdf/YYYY/...</span> ê²½ë¡œë¡œ ì½ìŠµë‹ˆë‹¤.
      </div>
    </div>

    <canvas id="canvas"></canvas>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.js";

    const statusEl = document.getElementById("status");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d", { alpha: false });

    function setStatus(msg){ statusEl.textContent = msg; }

    function ymd(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function parseDateInput(id){
      const v = document.getElementById(id).value;
      if(!v) return null;
      const d = new Date(v + "T00:00:00");
      return isNaN(d) ? null : d;
    }

    function daysInMonth(year, month1to12){
      return new Date(year, month1to12, 0).getDate();
    }

    function groupStartMonth(month1to12){
      return (month1to12 % 2 === 1) ? month1to12 : month1to12 - 1;
    }

    function* dateRange(start, end){
      const cur = new Date(start);
      while(cur <= end){
        yield new Date(cur);
        cur.setDate(cur.getDate() + 1);
      }
    }

    function isWeekend(d){
      const w = d.getDay(); // 0 Sun ... 6 Sat
      return (w === 0 || w === 6);
    }

    function encodeParens(url){
      return url.replaceAll("(", "%28").replaceAll(")", "%29");
    }

    // âœ… ì›ë³¸(êµíšŒ) PDF URL
    function buildRemotePdfUrl(year, startMonth){
      const raw = `https://www.woorichurch.org/sub/bible/${year}/${year}_ov_${startMonth}-${startMonth+1}(2).pdf`;
      return encodeParens(raw);
    }

    // âœ… GitHub ì €ì¥ì†Œì— ì˜¬ë¦° PDF ìƒëŒ€ê²½ë¡œ (repoì— pdf/ì—°ë„/íŒŒì¼.pdf í˜•íƒœë¡œ ë„£ëŠ” ê°€ì •)
    function buildLocalPdfUrl(year, startMonth){
      const raw = `./pdf/${year}/${year}_ov_${startMonth}-${startMonth+1}(2).pdf`;
      return encodeParens(raw);
    }

    function planForDate(d){
      const year = d.getFullYear();
      const month = d.getMonth()+1;
      const day = d.getDate();

      const startM = groupStartMonth(month);
      const secondM = startM + 1;
      const firstMonthDays = daysInMonth(year, startM);

      let pageNumber;
      if(month === startM) pageNumber = 4 + day;
      else if(month === secondM) pageNumber = 4 + firstMonthDays + day;
      else pageNumber = 4 + day;

      const pdfKey = `${year}-${String(startM).padStart(2,"0")}`;
      const fileName = `${ymd(d)}.png`;
      return { year, startM, pdfKey, pageNumber, fileName };
    }

    async function loadPdf(pdfUrl){
      // pdf.js ë‚´ë¶€ fetch ì‚¬ìš©
      return await pdfjsLib.getDocument({ url: pdfUrl }).promise;
    }

    async function renderPageToDataUrl(pdf, pageNumber, scale){
      const page = await pdf.getPage(pageNumber);
      const viewport = page.getViewport({ scale });
      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);
      await page.render({ canvasContext: ctx, viewport }).promise;
      return canvas.toDataURL("image/png");
    }

    function downloadDataUrl(dataUrl, filename){
      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function validateRange(start, end){
      if(!start || !end) return "ì‹œì‘/ì¢…ë£Œ ë‚ ì§œë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.";
      if(end < start) return "ì¢…ë£Œ ë‚ ì§œëŠ” ì‹œì‘ ë‚ ì§œë³´ë‹¤ ë¹ ë¥¼ ìˆ˜ ì—†ì–´ìš”.";
      const diffDays = Math.floor((end - start) / (24*3600*1000)) + 1;
      if(diffDays > 90) return "ê¸°ê°„ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤(ìµœëŒ€ 90ì¼). ë²”ìœ„ë¥¼ ì¤„ì—¬ì£¼ì„¸ìš”.";
      return null;
    }

    async function run({ zipMode }){
      const start = parseDateInput("startDate");
      const end = parseDateInput("endDate");
      const includeWeekend = document.getElementById("includeWeekend").checked;
      const useLocalPdf = document.getElementById("useLocalPdf").checked;
      const scale = Number(document.getElementById("quality").value || "2");

      const err = validateRange(start, end);
      if(err){ alert(err); return; }

      const dates = [];
      for(const d of dateRange(start, end)){
        if(!includeWeekend && isWeekend(d)) continue;
        dates.push(d);
      }
      if(dates.length === 0){
        alert("ì„ íƒëœ ê¸°ê°„ì—ì„œ ë‹¤ìš´ë¡œë“œí•  ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤. (ì£¼ë§ ì œì™¸ ì„¤ì • í™•ì¸)");
        return;
      }

      setStatus(`ì¤€ë¹„ ì¤‘â€¦
ê¸°ê°„: ${ymd(start)} ~ ${ymd(end)}
ëŒ€ìƒ: ${dates.length}ê°œ
ëª¨ë“œ: ${zipMode ? "ZIP" : "ê°œë³„"}
PDF ì†ŒìŠ¤: ${useLocalPdf ? "GitHub(ë¡œì»¬)" : "êµíšŒ(ì›ë³¸)"}
í•´ìƒë„: ${scale}x`);

      // PDFë³„ë¡œ ë¬¶ê¸°
      const groups = new Map(); // pdfKey -> { pdfUrl, items: [] }
      for(const d of dates){
        const p = planForDate(d);
        const pdfUrl = useLocalPdf ? buildLocalPdfUrl(p.year, p.startM) : buildRemotePdfUrl(p.year, p.startM);

        if(!groups.has(p.pdfKey)){
          groups.set(p.pdfKey, { pdfUrl, items: [] });
        }
        groups.get(p.pdfKey).items.push({ pageNumber: p.pageNumber, fileName: p.fileName });
      }

      const zip = zipMode ? new JSZip() : null;

      try{
        let done = 0;
        const total = dates.length;

        for(const [pdfKey, group] of groups.entries()){
          setStatus(`PDF ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦
${pdfKey}
${group.pdfUrl}`);

          const pdf = await loadPdf(group.pdfUrl);

          for(const item of group.items){
            setStatus(`ì´ë¯¸ì§€ ìƒì„± ì¤‘â€¦ (${done+1}/${total})
PDF: ${pdfKey} / page: ${item.pageNumber}
file: ${item.fileName}`);

            const dataUrl = await renderPageToDataUrl(pdf, item.pageNumber, scale);

            if(zipMode){
              zip.file(item.fileName, dataUrl.split(",")[1], { base64: true });
            }else{
              downloadDataUrl(dataUrl, item.fileName);
              await new Promise(r => setTimeout(r, 250));
            }
            done++;
          }
        }

        if(zipMode){
          setStatus("ZIP ìƒì„± ì¤‘â€¦");
          const blob = await zip.generateAsync({ type: "blob" });
          const url = URL.createObjectURL(blob);
          const name = `meditation_${ymd(start)}_${ymd(end)}${includeWeekend ? "_withWeekend" : ""}.zip`;
          const a = document.createElement("a");
          a.href = url;
          a.download = name;
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(() => URL.revokeObjectURL(url), 2000);
        }

        setStatus(`ì™„ë£Œ âœ…
ê¸°ê°„: ${ymd(start)} ~ ${ymd(end)}
ë‹¤ìš´ë¡œë“œ: ${dates.length}ê°œ
ì£¼ë§ í¬í•¨: ${includeWeekend ? "ì˜ˆ" : "ì•„ë‹ˆì˜¤"}
ëª¨ë“œ: ${zipMode ? "ZIP" : "ê°œë³„"}`);

      }catch(e){
        console.error(e);
        setStatus(`ì˜¤ë¥˜ âš ï¸
${e?.message || String(e)}

ê°€ëŠ¥í•œ ì›ì¸:
1) (ê°€ì¥ í”í•¨) êµíšŒ PDF ì„œë²„ê°€ CORSë¥¼ í—ˆìš©í•˜ì§€ ì•ŠìŒ â†’ "PDFë¥¼ GitHub ì €ì¥ì†Œì— ì˜¬ë¦¼" ì²´í¬ í›„ ì‚¬ìš©
2) ë¡œì»¬(file://)ë¡œ ì—´ì–´ì„œ Originì´ nullì´ë¼ ì°¨ë‹¨ë¨ â†’ GitHub Pages(https)ì—ì„œ ì‹¤í–‰ ê¶Œì¥
3) ëª¨ë°”ì¼ì—ì„œ ì—°ì† ë‹¤ìš´ë¡œë“œê°€ ì°¨ë‹¨ë¨ â†’ ZIP ëª¨ë“œ ì‚¬ìš© ê¶Œì¥`);
        alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìƒíƒœ ë©”ì‹œì§€ì™€ (PCë©´) ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
      }
    }

    document.getElementById("btnEach").addEventListener("click", () => run({ zipMode:false }));
    document.getElementById("btnZip").addEventListener("click", () => run({ zipMode:true }));

    (function initDefaults(){
      const today = new Date();
      const t = ymd(today);
      document.getElementById("startDate").value = t;
      document.getElementById("endDate").value = t;
      setStatus("ëŒ€ê¸° ì¤‘â€¦\nì‹œì‘/ì¢…ë£Œ ë‚ ì§œë¥¼ ì„ íƒí•˜ê³  ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.");
    })();
  </script>
</body>
</html>
