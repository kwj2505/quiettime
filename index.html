<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬êµíšŒ í•œêµ¬ì ˆë¬µìƒ ì¶”ì¶œê¸° (ì•ˆì „ëª¨ë“œ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Noto Sans KR', 'sans-serif'] },
                    colors: {
                        church: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: #f3f4f6;
        }

        .glass {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Drag & Drop Zone Animation */
        .drag-active {
            border-color: #0ea5e9 !important;
            background-color: #f0f9ff !important;
            transform: scale(1.02);
        }
    </style>
</head>

<body class="text-slate-800 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Main Container -->
    <main class="w-full max-w-2xl glass shadow-xl rounded-2xl overflow-hidden">
        <!-- Header -->
        <header class="bg-church-600 text-white p-6 text-center">
            <h1 class="text-2xl font-bold">ğŸ“– í•œêµ¬ì ˆë¬µìƒ ì´ë¯¸ì§€ ì¶”ì¶œê¸°</h1>
            <p class="text-church-100 text-sm mt-1 opacity-90">ì•ˆì „í•˜ê³  ê°„í¸í•œ PDF ë³€í™˜ ë„êµ¬ v4.1</p>
        </header>

        <!-- Content -->
        <div class="p-6 space-y-8">

            <!-- Step 1: Download & Select -->
            <div class="space-y-4">
                <div class="flex items-center gap-2">
                    <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">Step 1</span>
                    <h3 class="font-bold text-slate-800">ë‚ ì§œ ì„ íƒ ë° PDF ì¤€ë¹„</h3>
                </div>

                <!-- Date Controls -->
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">ì—°ë„</label>
                        <input type="number" id="targetYear"
                            class="w-full p-2 border rounded-lg text-center font-bold text-church-900"
                            onchange="updateLink()">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">ì›” (ìë™ê³„ì‚°)</label>
                        <select id="targetMonthPair"
                            class="w-full p-2 border rounded-lg bg-white font-bold text-church-900"
                            onchange="updateLink()">
                            <option value="1">1-2ì›”í˜¸</option>
                            <option value="3">3-4ì›”í˜¸</option>
                            <option value="5">5-6ì›”í˜¸</option>
                            <option value="7">7-8ì›”í˜¸</option>
                            <option value="9">9-10ì›”í˜¸</option>
                            <option value="11">11-12ì›”í˜¸</option>
                        </select>
                    </div>
                </div>

                <!-- Smart Link Button -->
                <div class="text-center">
                    <a id="smartLink" href="#" target="_blank"
                        class="inline-flex items-center gap-2 text-church-600 hover:text-church-800 font-medium text-sm hover:underline transition">
                        <span>ğŸ”— ì´ë²ˆ ë‹¬ êµíšŒ PDF ë‹¤ìš´ë¡œë“œí•˜ëŸ¬ ê°€ê¸°</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                    </a>
                    <p class="text-xs text-slate-400 mt-2">
                        <span class="bg-slate-200 text-slate-700 px-1 rounded text-[10px] font-bold">ì•„ì´í° ì‚¬ìš©ì</span>
                        ë§í¬ í´ë¦­ â†’ í•˜ë‹¨ <span class="font-bold">[ê³µìœ ]</span> ë²„íŠ¼ â†’ <span class="font-bold">[íŒŒì¼ì— ì €ì¥]</span> í›„
                        ì•„ë˜ì— ë„£ì–´ì£¼ì„¸ìš”.
                    </p>
                </div>

                <!-- Drop Zone & Mobile Select -->
                <div id="dropZone"
                    class="flex flex-col items-center justify-center w-full h-40 border-2 border-dashed border-slate-300 rounded-xl bg-slate-50 hover:bg-slate-100 transition-all group relative">

                    <!-- Drag Message (PC) -->
                    <div class="hidden md:flex flex-col items-center pointer-events-none">
                        <svg class="w-8 h-8 mb-3 text-slate-400 group-hover:text-church-500 transition" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                            </path>
                        </svg>
                        <p class="text-sm text-slate-500 font-medium">ì—¬ê¸°ë¡œ PDF íŒŒì¼ì„ ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”</p>
                    </div>

                    <!-- Mobile/Click Button -->
                    <button onclick="document.getElementById('pdfFile').click()"
                        class="md:mt-4 bg-white border border-slate-300 text-slate-700 hover:text-church-600 hover:border-church-400 font-bold py-3 px-6 rounded-full shadow-sm flex items-center gap-2 transition z-10 cursor-pointer">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                        </svg>
                        ğŸ“‚ PDF íŒŒì¼ ì„ íƒí•˜ê¸°
                    </button>

                    <p id="fileNameDisplay" class="text-xs text-slate-400 mt-2">PDF íŒŒì¼ (.pdf)</p>

                    <!-- Hidden Input: accept='*/*' solves Android 'grayed out' issue -->
                    <input type="file" id="pdfFile" accept="*/*" class="hidden" onchange="handleFileSelect(this)">
                </div>

                <!-- Debug/Calibration Info -->
                <div class="bg-slate-100 p-3 rounded-lg border border-slate-200 text-xs">
                    <div class="flex justify-between items-center cursor-pointer"
                        onclick="document.getElementById('debugOpts').classList.toggle('hidden')">
                        <span class="font-bold text-slate-600">ğŸ› ï¸ í˜ì´ì§€ ê³„ì‚° í™•ì¸ (ê³ ê¸‰ ì„¤ì •)</span>
                        <span class="text-slate-400">â–¼</span>
                    </div>
                    <div id="debugOpts" class="hidden mt-2 space-y-2">
                        <div class="flex items-center gap-2">
                            <span>ì§ìˆ˜ë‹¬(2,4..) ì‹œì‘ ë³´ì •ê°’:</span>
                            <input type="number" id="month2Offset" value="0" class="w-16 p-1 border rounded text-center"
                                onchange="updateDebugInfo()">
                            <span class="text-slate-400">í˜ì´ì§€</span>
                        </div>
                        <p class="text-slate-500">â€» ì§ìˆ˜ë‹¬ ì‹œì‘ í˜ì´ì§€ê°€ ì•ˆ ë§ìœ¼ë©´ ìˆ«ìë¥¼ ì¡°ì ˆí•˜ì„¸ìš”. (ì˜ˆ: í‘œì§€ê°€ ìˆìœ¼ë©´ +1)</p>
                        <div class="bg-white p-2 rounded border mt-1">
                            <p id="calcPreview" class="font-mono text-church-600">í˜„ì¬ ì„¤ì • ê¸°ì¤€:<br>1ì›” 31ì¼ = ??p<br>2ì›” 1ì¼ =
                                ??p</p>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="border-slate-200">

            <!-- Step 2: Settings & Extract -->
            <div class="space-y-4">
                <div class="flex items-center gap-2">
                    <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">Step 2</span>
                    <h3 class="font-bold text-slate-800">ê¸°ê°„ ì„¤ì • ë° ì¶”ì¶œ</h3>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">ì‹œì‘ì¼</label>
                        <input type="date" id="startDate" class="w-full p-2 border rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">ì¢…ë£Œì¼</label>
                        <input type="date" id="endDate" class="w-full p-2 border rounded-lg text-sm">
                    </div>
                </div>

                <!-- Preset Buttons -->
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <button onclick="setPreset('today')"
                        class="bg-white border border-slate-300 text-slate-600 font-bold py-2 rounded-lg hover:bg-slate-50 text-sm">ğŸ“…
                        ì˜¤ëŠ˜</button>
                    <button onclick="setPreset('tomorrow')"
                        class="bg-white border border-slate-300 text-slate-600 font-bold py-2 rounded-lg hover:bg-slate-50 text-sm">ğŸŒ…
                        ë‚´ì¼</button>
                    <button onclick="setPreset('week')"
                        class="bg-white border border-slate-300 text-slate-600 font-bold py-2 rounded-lg hover:bg-slate-50 text-sm">ğŸ—“ï¸
                        ì´ë²ˆ ì£¼</button>
                    <button onclick="setPreset('nextWeek')"
                        class="bg-white border border-slate-300 text-slate-600 font-bold py-2 rounded-lg hover:bg-slate-50 text-sm">ğŸ”œ
                        ë‹¤ìŒ ì£¼</button>
                </div>

                <div class="flex items-center space-x-2 px-1">
                    <input type="checkbox" id="includeWeekend"
                        class="rounded text-church-600 focus:ring-church-500 w-5 h-5">
                    <label for="includeWeekend"
                        class="text-sm text-slate-700 font-medium cursor-pointer select-none">ì£¼ë§(í† /ì¼) ë° ê°€ì •ì˜ˆë°° í¬í•¨</label>
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 pt-2">
                    <button onclick="processAndDownload('view')" id="btnView"
                        class="w-full bg-white border-2 border-church-500 text-church-600 hover:bg-church-50 font-bold py-3 px-4 rounded-xl shadow-md transition active:scale-95 flex justify-center items-center gap-2"
                        disabled>
                        <span>ğŸ“±</span> ëª¨ë°”ì¼ ë³´ê¸° (ì €ì¥)
                    </button>
                    <button onclick="processAndDownload('zip')" id="btnDownload"
                        class="w-full bg-church-600 hover:bg-church-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition active:scale-95 flex justify-center items-center gap-2"
                        disabled>
                        <span>ğŸ’¾</span> ZIP ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
            </div>

            <!-- Status & Gallery -->
            <div id="statusArea"
                class="hidden bg-slate-800 text-slate-200 p-4 rounded-lg font-mono text-xs max-h-40 overflow-y-auto whitespace-pre-wrap">
            </div>

            <div id="imageGallery"
                class="hidden flex flex-col gap-4 mt-4 bg-slate-50 p-4 rounded-xl border border-slate-200">
                <div class="bg-blue-50 text-blue-700 p-3 rounded-lg text-xs leading-relaxed">
                    <p><strong>ğŸ’¡ ì €ì¥ëœ íŒŒì¼ì´ ì•ˆ ë³´ì´ì‹œë‚˜ìš”?</strong></p>
                    <ul class="list-disc pl-4 mt-1 space-y-1">
                        <li><strong>[ê³µìœ /ì €ì¥] ë²„íŠ¼</strong>ì„ ëˆ„ë¥´ê³  <strong>'ì´ë¯¸ì§€ ì €ì¥'</strong>ì„ ì„ íƒí•˜ë©´ ê°¤ëŸ¬ë¦¬(ì•¨ë²”)ì— ë°”ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤.</li>
                        <li><strong>[ë‹¤ìš´ë¡œë“œ] ë²„íŠ¼</strong>ì€ <strong>'ë‚´ íŒŒì¼' > 'ë‹¤ìš´ë¡œë“œ'</strong> í´ë”ì— ì €ì¥ë©ë‹ˆë‹¤.</li>
                        <li>ê·¸ë˜ë„ ì•ˆ ë˜ë©´ <strong>ì´ë¯¸ì§€ë¥¼ 1ì´ˆê°„ ê¾¹ ëˆŒëŸ¬ì„œ</strong> ì €ì¥í•˜ì„¸ìš”.</li>
                    </ul>
                </div>
                <div id="galleryGrid" class="grid grid-cols-1 gap-6"></div>
            </div>

        </div>
        <footer class="bg-slate-50 border-t p-4 text-center text-xs text-slate-400">
            Meditation Extractor v4.1 â€¢ Mobile Compatible
        </footer>
    </main>

    <!-- Hidden Canvas -->
    <canvas id="renderCanvas" class="hidden"></canvas>

    <script>
        // --- 1. Initialization ---
        const today = new Date();
        const yearInput = document.getElementById('targetYear');
        const monthSelect = document.getElementById('targetMonthPair');

        // [New] KakaoTalk/In-App Browser Warning
        if (navigator.userAgent.match(/KAKAOTALK|Instagram|NAVER|Line/i)) {
            const warning = document.createElement('div');
            warning.className = "bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 text-sm font-bold shadow-lg";
            warning.innerHTML = `
                <p>âš ï¸ ì¹´ì¹´ì˜¤í†¡/ì¸ì•± ë¸Œë¼ìš°ì €ì—ì„œëŠ”<br>íŒŒì¼ ë‹¤ìš´ë¡œë“œ/ì„ íƒì´ ì˜ ì•ˆë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <p class="mt-2 text-xs font-normal">ìš°ì¸¡ í•˜ë‹¨(ë˜ëŠ” ìƒë‹¨)ì˜ <span class="bg-white border rounded px-1">â‹®</span> ë²„íŠ¼ì„ ëˆ„ë¥´ê³ <br><strong>[ë‹¤ë¥¸ ë¸Œë¼ìš°ì €(Chrome/Safari)ë¡œ ì—´ê¸°]</strong>ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
            `;
            document.querySelector('.glass .p-6').prepend(warning);
        }

        // Default Logic
        yearInput.value = today.getFullYear();
        const m = today.getMonth() + 1;
        // Map 1->1, 2->1, 3->3, 4->3, etc.
        const startM = m % 2 !== 0 ? m : m - 1;
        if ([1, 3, 5, 7, 9, 11].includes(startM)) monthSelect.value = startM;

        document.getElementById('startDate').valueAsDate = today;
        document.getElementById('endDate').valueAsDate = today;

        updateLink(); // Set initial link

        // --- 2. Smart Link Logic ---
        function updateLink() {
            const y = yearInput.value;
            const m1 = parseInt(monthSelect.value);
            const m2 = m1 + 1;

            // Generate official URL
            const fileName = `${y}_ov_${m1}-${m2}(2).pdf`; // e.g., 2026_ov_1-2(2).pdf
            const url = `https://www.woorichurch.org/sub/bible/${y}/${fileName}`;

            const linkEl = document.getElementById('smartLink');
            linkEl.href = url;
            linkEl.innerHTML = `<span>ğŸ”— ${y}ë…„ ${m1}-${m2}ì›”í˜¸ ë‹¤ìš´ë¡œë“œ (êµíšŒ í™ˆí˜ì´ì§€)</span> <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>`;

            // Update link text for feedback
            linkEl.onclick = () => {
                setTimeout(() => alert('PDF ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ë©´, ì•„ë˜ ìƒìì— íŒŒì¼ì„ ë„£ì–´ì£¼ì„¸ìš”!'), 1500);
            };

            updateDebugInfo();
        }

        // Debug Info Logic
        document.getElementById('month2Offset').addEventListener('input', updateDebugInfo);

        function updateDebugInfo() {
            const y = parseInt(yearInput.value);
            const m1 = parseInt(monthSelect.value);
            const m2 = m1 + 1;
            const offset = parseInt(document.getElementById('month2Offset').value) || 0;

            // Last day of M1
            const lastM1 = new Date(y, m1, 0); // Month is 0-indexed in Date constructor? No, new Date(y, m, 0) gives last day of month 'm-1'
            // Wait, Date(y, monthIndex) -> 0=Jan.
            // new Date(2026, 1, 0) -> Last day of Jan (Month 1).
            // m1 is 1. new Date(y, m1, 0) -> Jan 31. Correct.
            const d1 = new Date(y, m1 - 1, new Date(y, m1, 0).getDate());

            // First day of M2
            const d2 = new Date(y, m1, 1);

            const p1 = getPagesForDate(d1, m1, offset);
            const p2 = getPagesForDate(d2, m1, offset);

            const p1Str = p1.length ? p1[0].num + 'p' : '?';
            const p2Str = p2.length ? p2[0].num + 'p' : '?';

            document.getElementById('calcPreview').innerHTML =
                `${m1}ì›” ë§(${d1.getDate()}ì¼): <strong>${p1Str}</strong> (ë)<br>` +
                `${m2}ì›” 1ì¼: <strong>${p2Str}</strong> (ì‹œì‘)`;
        }

        // --- 3. File Handling ---
        let selectedFile = null;

        function handleFileSelect(input) {
            const file = input.files[0];
            if (file) setFile(file);
        }

        function setFile(file) {
            // Android sometimes gives generic type, so check extension too
            const isPdfType = file.type === 'application/pdf';
            const isPdfExt = file.name.toLowerCase().endsWith('.pdf');

            if (!isPdfType && !isPdfExt) {
                alert('âš ï¸ PDF íŒŒì¼ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n\nì„ íƒí•˜ì‹  íŒŒì¼: ' + file.name + '\n(' + (file.type || 'ì•Œ ìˆ˜ ì—†ëŠ” í˜•ì‹') + ')');
                return;
            }

            selectedFile = file;
            document.getElementById('fileNameDisplay').textContent = `âœ… ì„ íƒë¨: ${file.name}`;
            document.getElementById('fileNameDisplay').className = "text-sm text-church-600 font-bold mt-2";
            document.getElementById('dropZone').classList.add('bg-blue-50', 'border-church-300');

            // Enable buttons
            document.getElementById('btnView').disabled = false;
            document.getElementById('btnDownload').disabled = false;
        }

        // Drag & Drop
        const dropZone = document.getElementById('dropZone');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-active'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-active'), false);
        });
        dropZone.addEventListener('drop', (e) => {
            const file = e.dataTransfer.files[0];
            if (file) setFile(file);
        }, false);


        // --- 4. Processing Logic ---

        // Helper: Count Sundays in a month up to specific day
        function countSundays(year, month, upToDay) {
            let count = 0;
            for (let d = 1; d <= upToDay; d++) {
                if (new Date(year, month - 1, d).getDay() === 0) count++;
            }
            return count;
        }

        // Helper: Total pages consumed by a month (Days + Worship Pages)
        function getTotalPagesForMonth(year, month) {
            const daysInMonth = new Date(year, month, 0).getDate();
            const sundays = countSundays(year, month, daysInMonth);
            return daysInMonth + sundays;
        }

        function getPagesForDate(date, startM, extraOffset = 0) {
            const INTRO_PAGES = 4;
            const y = date.getFullYear();
            const m = date.getMonth() + 1;
            const d = date.getDate();

            // Calculate Start Page offset based on month
            let basePage = INTRO_PAGES + 1; // Page 5 is start

            if (m === startM + 1) {
                // If 2nd month, add pages from 1st month
                basePage += getTotalPagesForMonth(y, startM);
                basePage += extraOffset; // Apply user offset for month 2
            } else if (m !== startM) {
                return []; // Out of range
            }

            // Calculate offset within the month
            // Page = Base + (Day-1) + (Sundays passed BEFORE today)
            // Note: Sunday itself does not add offset yet. The extra page is AFTER Sunday.
            // So we count Sundays strictly before 'd'.
            const sundaysBefore = countSundays(y, m, d - 1);

            const mainPage = basePage + (d - 1) + sundaysBefore;
            const pages = [{ num: mainPage, type: 'daily' }];

            // If Sunday, Worship page is next
            if (date.getDay() === 0) {
                pages.push({ num: mainPage + 1, type: 'worship' });
            }

            return pages;
        }

        // Preset Logic
        function setPreset(type) {
            const includeWeekend = document.getElementById('includeWeekend').checked;
            const s = document.getElementById('startDate');
            const e = document.getElementById('endDate');
            const t = new Date();

            if (type === 'today') {
                s.valueAsDate = t;
                e.valueAsDate = t;
            } else if (type === 'tomorrow') {
                const tmr = new Date(t);
                tmr.setDate(tmr.getDate() + 1);
                s.valueAsDate = tmr;
                e.valueAsDate = tmr;
            } else if (type === 'week') {
                // Find Monday of this week
                const day = t.getDay(); // 0(Sun) ~ 6(Sat)
                // If today is Sunday(0), "This Week" usually means PREV Monday? Or NEXT Monday?
                // Standard ISO: Mon is 1. If Sun(0), prev Mon is today-6.
                // Let's assume standard church week: Mon ~ Sun.
                const diff = t.getDate() - day + (day == 0 ? -6 : 1);
                const monday = new Date(t);
                monday.setDate(diff);

                s.valueAsDate = monday;

                // End date
                const endOffset = includeWeekend ? 6 : 4;
                const endDate = new Date(monday);
                endDate.setDate(monday.getDate() + endOffset);
                e.valueAsDate = endDate;
            } else if (type === 'nextWeek') {
                // Find Next Monday
                // First get this monday
                const day = t.getDay();
                const diff = t.getDate() - day + (day == 0 ? -6 : 1);
                const thisMonday = new Date(t);
                thisMonday.setDate(diff);

                const nextMonday = new Date(thisMonday);
                nextMonday.setDate(thisMonday.getDate() + 7);
                s.valueAsDate = nextMonday;

                const endOffset = includeWeekend ? 6 : 4;
                const endDate = new Date(nextMonday);
                endDate.setDate(nextMonday.getDate() + endOffset);
                e.valueAsDate = endDate;
            }
        }

        function log(msg, type = 'info') {
            const el = document.getElementById('statusArea');
            el.classList.remove('hidden');
            const color = type === 'error' ? 'text-red-300' : 'text-green-300';
            const icon = type === 'error' ? 'âŒ' : (type === 'success' ? 'âœ…' : 'â„¹ï¸');
            el.innerHTML += `<div>${icon} ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        }

        async function processAndDownload(mode) {
            if (!selectedFile) {
                alert('ë¨¼ì € PDF íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // UI Prep
            const btnZip = document.getElementById('btnDownload');
            const btnView = document.getElementById('btnView');
            const gallery = document.getElementById('imageGallery');
            const galleryGrid = document.getElementById('galleryGrid');
            const statusArea = document.getElementById('statusArea');

            // Reset
            statusArea.innerHTML = '';
            statusArea.classList.remove('hidden');
            gallery.classList.add('hidden');
            galleryGrid.innerHTML = '';

            // Lock UI
            btnZip.disabled = true; btnView.disabled = true;
            const originalZipText = btnZip.innerHTML;
            const originalViewText = btnView.innerHTML;
            btnZip.innerHTML = 'â³ ì²˜ë¦¬ì¤‘...';
            btnView.innerHTML = 'â³ ì²˜ë¦¬ì¤‘...';

            try {
                // 1. Inputs
                const start = new Date(document.getElementById('startDate').value);
                const end = new Date(document.getElementById('endDate').value);
                const includeWeekend = document.getElementById('includeWeekend').checked;
                const m1 = parseInt(monthSelect.value);
                const offset = parseInt(document.getElementById('month2Offset').value) || 0;

                if (start > end) throw new Error("ì‹œì‘ì¼ì´ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ìŠµë‹ˆë‹¤.");

                // 2. Load PDF
                const arrayBuffer = await selectedFile.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                log(`PDF ë¡œë“œë¨: ${selectedFile.name} (${pdf.numPages}í˜ì´ì§€)`);

                // 3. Process
                const zip = mode === 'zip' ? new JSZip() : null;
                const canvas = document.getElementById('renderCanvas');
                const ctx = canvas.getContext('2d');
                let count = 0;

                if (mode === 'view') gallery.classList.remove('hidden');

                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    // Check weekend Logic
                    // User says: 'week' preset is Mon-Fri. But checkbox allows Weekend.
                    // If manually range selected, we honor range.
                    // But if Checkbox is OFF, we skip Sat/Sun?
                    // Proposal: Checkbox mainly serves "Include Worship Page" AND "Extend Preset to Sun".
                    // But for manual range, let's keep it simple: If checkbox OFF, skip Sat/Sun.
                    if (!includeWeekend && (d.getDay() === 0 || d.getDay() === 6)) continue;

                    const pages = getPagesForDate(d, m1, offset);

                    for (const pg of pages) {
                        if (pg.num > pdf.numPages) {
                            log(`${d.toLocaleDateString()} : í˜ì´ì§€ ì´ˆê³¼ (Page ${pg.num})`, 'error');
                            continue;
                        }

                        // If it's worship page, skip if checkbox is unchecked
                        if (pg.type === 'worship' && !includeWeekend) continue;

                        // Render
                        const page = await pdf.getPage(pg.num);
                        const viewport = page.getViewport({ scale: 2.0 });
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                        const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.85));

                        let fileName = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                        if (pg.type === 'worship') fileName += '-worship';
                        fileName += '.jpg';

                        if (mode === 'zip') {
                            zip.file(fileName, blob);
                            log(`${d.getMonth() + 1}/${d.getDate()} ${pg.type === 'worship' ? '(ì˜ˆë°°)' : ''} ì¶”ì¶œ ì™„ë£Œ`);
                        } else {
                            // View Mode
                            const url = URL.createObjectURL(blob);

                            // Check for Web Share API support
                            const canShare = navigator.canShare && navigator.canShare({ files: [new File([blob], fileName, { type: 'image/jpeg' })] });

                            const card = document.createElement('div');
                            card.className = "bg-white p-3 rounded-lg shadow border border-slate-200";

                            let btnHtml = '';
                            if (canShare) {
                                btnHtml = `
                                <button onclick="shareImage(this)" data-filename="${fileName}" class="block w-full py-3 bg-church-600 text-white font-bold text-center rounded-lg hover:bg-church-700 transition cursor-pointer shadow-md flex items-center justify-center gap-2">
                                    <span>ğŸ“¤</span> ê³µìœ  / ê°¤ëŸ¬ë¦¬ ì €ì¥ (ì¶”ì²œ)
                                </button>
                            `;
                            } else {
                                btnHtml = `
                                <button onclick="downloadImage(this)" data-filename="${fileName}" class="block w-full py-3 bg-church-50 text-church-600 font-bold text-center rounded-lg hover:bg-church-100 transition cursor-pointer border border-church-200 flex items-center justify-center gap-2">
                                    <span>ğŸ’¾</span> íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
                                </button>
                            `;
                            }

                            card.innerHTML = `
                            <div class="font-bold text-center mb-2 text-church-600">
                                ${d.getFullYear()}.${d.getMonth() + 1}.${d.getDate()} 
                                ${pg.type === 'worship' ? '<span class="text-xs bg-orange-100 text-orange-600 px-1 rounded">ê°€ì •ì˜ˆë°°</span>' : ''}
                            </div>
                            <img src="${url}" class="w-full rounded-md shadow-inner mb-3 border">
                            ${btnHtml}
                        `;

                            // Store blob
                            const btn = card.querySelector('button');
                            btn.blobData = blob;

                            galleryGrid.appendChild(card);
                        }
                        count++;
                    }
                } // close outer loop

                if (count === 0) throw new Error("ì¶”ì¶œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");

                if (mode === 'zip') {
                    log(`ZIP ì••ì¶• ì¤‘...`);
                    const zipBlob = await zip.generateAsync({ type: "blob" });
                    saveAs(zipBlob, `ë¬µìƒ_${start.toISOString().split('T')[0]}_${end.toISOString().split('T')[0]}.zip`);
                    log(`ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!`, 'success');
                } else {
                    log(`${count}ì¥ ì¶”ì¶œ ì™„ë£Œ. ì•„ë˜ì—ì„œ í™•ì¸í•˜ì„¸ìš”.`, 'success');
                    gallery.scrollIntoView({ behavior: 'smooth' });
                }

            } catch (e) {
                log(`ì˜¤ë¥˜: ${e.message}`, 'error');
                console.error(e);
            } finally {
                btnZip.disabled = false; btnView.disabled = false;
                btnZip.innerHTML = originalZipText; btnView.innerHTML = originalViewText;
            }
        }

        // Helper: Share Image
        async function shareImage(btn) {
            if (!btn.blobData) return alert('ì´ë¯¸ì§€ ë°ì´í„° ì—†ìŒ');
            try {
                const file = new File([btn.blobData], btn.dataset.filename, { type: 'image/jpeg' });
                await navigator.share({
                    files: [file],
                    title: 'í•œêµ¬ì ˆ ë¬µìƒ',
                    text: 'ì˜¤ëŠ˜ì˜ ë¬µìƒ ì´ë¯¸ì§€ì…ë‹ˆë‹¤.'
                });
            } catch (err) {
                console.log('Share canceled or failed', err);
                // Fallback to download if share fails (e.g., user cancelled) is optional, 
                // but usually user just cancelled.
            }
        }

        // Helper for iOS/Cross-browser download
        function downloadImage(btn) {
            if (btn.blobData) {
                saveAs(btn.blobData, btn.dataset.filename);
            } else {
                alert('ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
    </script>
</body>

</html>